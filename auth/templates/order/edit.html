{% extends 'layouts/default.html' %}
{% from 'helpers/form.html' import group %}

{% set page_title = 'Edit Order' %}
{% set show_gateway = current_user.has_role('super-admin') or current_user.has_role('network-admin') %}

{% block content %}
    <div class="order-edit content">
        <form method="post" action="{{ url_for('.order_edit', hash=order.hash) }}" class="order-item pure-form pure-g">
            {{ order_form.csrf_token }}

            {% if show_gateway %}
                <div class="pure-u-1">
                    {{ order_form.gateway }}
                </div>
            {% endif %}
            <div class="pure-u-1 product">
                {{ order_form.product }}
            </div>
            <div class="pure-u-1-3 quantity">
                {{ order_form.quantity(type='number', min=1) }}
            </div>
            <div class="pure-u-1-3 price">
                {{ order_form.price(type='number', min=0.01, step=0.01) }}
            </div>
            <div class="pure-u-1-3 submit">
                <button type="submit" class="pure-button pure-button-primary">
                    Add
                </button>
            </div>
        </form>

        <hr class="divider" />

        {% for item in order.items %}
            <form method="post" action="{{ url_for('.order_item_edit', hash=order.hash, item_id=item.id) }}" class="order-item pure-form pure-g">
                <div class="pure-u-2-3 product">
                    {{ order_form.product(value=item.product) }}
                </div>
                <div class="pure-u-1-3 submit">
                    <button
                        type="submit"
                        class="pure-button pure-button-secondary"
                        name="action"
                        value="remove"
                    >
                        Remove
                    </button>
                </div>
                <div class="pure-u-1-3 quantity">
                    {{ order_form.quantity(type='number', min=1, value=item.quantity) }}
                </div>
                <div class="pure-u-1-3 price">
                    {{ order_form.price(type='number', min=0.01, step=0.01, value='%.2f' % item.price) }}
                </div>
                <div class="pure-u-1-3 submit">
                    <button type="submit" class="pure-button pure-button-primary"
                        name="action"
                        value="save">
                        Save
                    </button>
                </div>
            </form>
        {% endfor %}

        <h3>
            Total: {{ render_currency_amount(order.network.currency, order.total_amount) }}
        </h3>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
var prices = {{ prices | tojson }};
Zepto(function($) {
    $('#product')
        .on('change', function (e) {
            var price = prices[$(this).val()];
            $('#price').val(price.toFixed(2));
        })
        .trigger('change');
});
</script>
{% endblock %}
